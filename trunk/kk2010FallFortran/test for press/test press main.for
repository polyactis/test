C
C     MAIN APPLIES APPROXIMATION FACTORISATION TO SOLVE
C     THE STEADY FLOW PROBLEM  FOR U(X,Y) AND V(X,Y) .
C     
C
	REAL*8 SUMP,RMSP,DSQRT,AN
      DIMENSION U(41,41),DU(41,41),V(41,41),DV(41,41),P(41,41),D(41,41)			  
	DIMENSION JPVT(1600),DVE(1600),AJ(1600,1600),X(31),Y(31)
	DIMENSION PE(41,41),ERRP(41,41)
      COMMON DX,DY,NX,NY,U,DU,V,DV,P
      OPEN(1,FILE='test.dat')
      OPEN(6,FILE='test.out')
      READ(1,1)NX,NY
    1 FORMAT(2I5)

C
      PI = 3.1415926
	NXS = NX + 1
      NYS = NY + 1
      NXP = NX - 1
      NYP = NY - 1
  	NXY = NX*NY

      ANX = NXP
      DX = 1./ANX
      ANY = NYP
      DY = 1./ANY

	AN = NX*NY

	DO 3 J=1,NX
	X(J) = 1.*(J-1)*DX
    3	CONTINUE

	DO 4 K=1,NY
	AK = K-1
   	Y(K) = 1.*AK*DY
    4	CONTINUE



      WRITE(6,5)NX,NY
    5 FORMAT(' STEADY FLOW WITH NX,NY =',2I5,/)

C
C     GENERATE INITIAL SOLUTION
C


C	PRESSURE STEP 
	
C     COMPUTE D(K,J)
	DO 20 K=1,NY
	DO 19 J=1,NX
	D(K,J) = 0.
   19	CONTINUE
   20 CONTINUE
     
      DO 22 K=1,NY
	DO 21 J=1,NX 
	D(K,J) = cos(PI*X(J))*cos(PI*Y(K))
   21	D(K,J) = 2.*PI*PI*D(K,J)
   22	CONTINUE

	DO 95 K=1,NY
	WRITE (6,96) (D(K,J),J=1,NX)
   96	FORMAT('D oooriginal =', 11F7.3)
   95 CONTINUE

	DO 222 K=1,NY
	DO 221 J=1,NX
	P(K,J) = 0.
  221	CONTINUE
  222 CONTINUE

	P(NY,NX)=1.

	DO 23 J=1,NX
   	D(1,J) = 0.
   23	D(NY,J) =0.
   
   	DO 24 K=1,NY
	D(K,1) = 0.
   24	D(K,NX) =0.


	DO 97 K=1,NY
	WRITE (6,98) (D(K,J),J=1,NX)
   98	FORMAT('D original =', 11F7.3)
   97 CONTINUE

	D(NY-1,NX) = D(NY-1,NX) + 1./(DY*DY)
	D(NY,NX-1) = D(NY,NX-1) + 1./(DX*DX)
	D(NY,NX) = 1

	D = TRANSPOSE(D)

C     EVALUATE COEFFICENT MATRIX OF PRESSURE EQUATION 
C	AND GET VECTOR FOR D(J,K)
	
      CALL PRESS(AJ)

C	WRITE (6,48) (AJ(K,NX*NY),K=1,NX*NY)
C   48	FORMAT('AJ AT last row', 121E11.4)
	
C	DO 99 J=1,NX*NY
C	WRITE (6,55) (AJ(J,K),K=1,NX*NY)
C   55	FORMAT('AJ=', 121E11.4)
C   99 CONTINUE

	DO 50 J=1,NX
	WRITE (6,49) (D(J,K),K=1,NY)
   49	FORMAT('D=', 11F7.3)
   50 CONTINUE


	DO 224 J =1,NX*NY
		DVE(J) = 0.
  224	CONTINUE

	DO 226 J = 1,NX
	DO 225 K = 1,NY
		DVE((J-1)*NY+K) = D(J,K)
  225	CONTINUE
  226 CONTINUE

  	WRITE (6,51) (DVE(K),K=1,NX*NY)
   51	FORMAT('DVE', 121E11.4)


C	FACTORISE THE COEFFICIENT MATRIX INTO L.U.

      CALL FACT(NXY-1,AJ,JPVT)

	IF(JPVT(NXY) .EQ. -1) WRITE (6,25)
   25	FORMAT('ZERO PIVOT DETECTED')
	IF(JPVT(NXY) .EQ. -1) GOTO 52

C     SOLVE FOR THE PRESSURE
	
	CALL SOLVE(NXY-1,AJ,JPVT,DVE)

	WRITE(6,77) (DVE(J),J=1,NX*NY)
   77	FORMAT ('DVE After SOLVE', 121E11.4)


	DO 27 J=1,NX
	DO 26 K=1,NY
	M=(J-1)*NY + K
	P(J,K) = DVE(M)
   26	CONTINUE
   27	CONTINUE
C
C     COMPARE WITH EXACT SOLUTION
C

      

	DO 33 K=1,NY
	SUMP = 0.
	DO 32 J=1,NX
   	PE(J,K) = cos(PI*X(J))*cos(PI*Y(K)) 
	ERRP(J,K) = PE(J,K) - P(J,K)
   	SUMP = SUMP + ERRP(J,K)**2
   32	CONTINUE
      WRITE (6,34) (P(J,K),J=1,NX)
   34	FORMAT('P= ', 11F7.3)
   33	CONTINUE
	RMSP = DSQRT(SUMP/AN) 

	DO 36 K=1,NY
	WRITE (6,35) (PE(J,K),J=1,NX)
   35	FORMAT('PE=', 11F7.3)
   36 CONTINUE

C	PRINT RMS ERROR FOR THE U VELOCITY AT OUTFLOW
	WRITE(6,45)RMSP
   45	FORMAT(' RMSP=',D11.4)


   52 CONTINUE
      STOP
      END

